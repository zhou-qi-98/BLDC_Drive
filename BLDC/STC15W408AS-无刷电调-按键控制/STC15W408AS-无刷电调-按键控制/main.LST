C51 COMPILER V9.54   MAIN                                                                  08/26/2021 23:45:46 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND

line level    source

   1          
   2          /*---------------------------------------------------------------------*/
   3          /* --- STC MCU International Limited ----------------------------------*/
   4          /* --- STC 1T Series MCU Demo Programme -------------------------------*/
   5          /* --- Mobile: 13922805190 --------------------------------------------*/
   6          /* --- Fax: 0513-55012956,55012947,55012969 ---------------------------*/
   7          /* --- Tel: 0513-55012928,55012929,55012966 ---------------------------*/
   8          /* --- Web: www.GXWMCU.com   www.stcmcu.com ---------------------------*/
   9          /* --- QQ:  800003751 -------------------------------------------------*/
  10          /* Èç¹ûÒªÔÚ³ÌÐòÖÐÊ¹ÓÃ´Ë´úÂë,ÇëÔÚ³ÌÐòÖÐ×¢Ã÷Ê¹ÓÃÁËºê¾§¿Æ¼¼µÄ×ÊÁÏ¼°³ÌÐò   */
  11          /*---------------------------------------------------------------------*/
  12          
  13          
  14          /*************  ¹¦ÄÜËµÃ÷        **************
  15          
  16          ±¾³ÌÐòÊÔÑéÊ¹ÓÃSTC15W401AS-35I-SOP16<RMB1.6>À´Çý¶¯º½Ä£ÓÃµÄÎÞ´«¸ÐÆ÷ÎÞË¢ÈýÏàÖ±Á÷Âí´ï.
  17          
  18          ±¾³ÌÐò²Î¿¼×ÔÍøÉÏµÄ´úÂë(×÷Õß: ÈðÉú), ¸ÄÁ¼¶øÀ´.
  19          
  20          µçÂ·Í¼¼ûÎÄ¼þ "BLDC-V10-ÊµÑéµçÂ·.pdf".
  21          
  22          ¿ØÖÆÐÅºÅÓÉP3.2ÊäÈëÕýÂö³åÐÅºÅ, ¼ä¸ô5~20ms, Âö³å¿í¶È1.000~1.610ms.
  23          
  24          1.160ms¿ªÊ¼Æô¶¯, 1.610msÎª×î¸ßËÙ¶È, ·Ö±æÂÊÎª2us.
  25          
  26          ±¾³ÌÐò½ö½öÊÇ¼òµ¥¿ØÖÆ, Èí¼þÃ»ÓÐ´¦Àí ¹ý0ÑÓÊ±30¶ÈÇÐ»» ¹ýÁ÷¼ì²â.
  27          
  28          ÓÉÓÚ¹ý0¼ì²â²¿·ÖÓÐRCÂË²¨, ËùÒÔ¸Ä±äµçÈÝÖµ¿ÉÒÔ´óÔ¼µÄ¶ÔÓ¦ÔÚ×î¸ßËÙÊ±ÑÓÊ±30¶ÈµÄÊ±¼ä.
  29          
  30          ÓÐÒâÕß¿É×ÔÐÐÍêÉÆµçÂ·ºÍ³ÌÐò.
  31          
  32          ******************************************/
  33          
  34          #define MAIN_Fosc               24000000L       //¶¨ÒåÖ÷Ê±ÖÓ
  35          
  36          #include "STC15Fxxxx.H"
  37          
  38          //CMPCR1
  39          #define CMPEN   0x80    //1: ÔÊÐí±È½ÏÆ÷, 0: ½ûÖ¹,¹Ø±Õ±È½ÏÆ÷µçÔ´
  40          #define CMPIF   0x40    //±È½ÏÆ÷ÖÐ¶Ï±êÖ¾, °üÀ¨ÉÏÉýÑØ»òÏÂ½µÑØÖÐ¶Ï, Èí¼þÇå0
  41          #define PIE             0x20    //1: ±È½Ï½á¹ûÓÉ0±ä1, ²úÉúÉÏÉýÑØÖÐ¶Ï
  42          #define NIE             0x10    //1: ±È½Ï½á¹ûÓÉ1±ä0, ²úÉúÏÂ½µÑØÖÐ¶Ï
  43          #define PIS             0x08    //ÊäÈëÕý¼«ÐÔÑ¡Ôñ, 0: Ñ¡ÔñÍâ²¿P5.5×öÕýÊäÈë,           1: ÓÉADCIS[2:0]ËùÑ¡ÔñµÄADCÊäÈë¶Ë×öÕ
             -ýÊäÈë.
  44          #define NIS             0x04    //ÊäÈë¸º¼«ÐÔÑ¡Ôñ, 0: Ñ¡ÔñÄÚ²¿BandGapµçÑ¹BGv×ö¸ºÊäÈë, 1: Ñ¡ÔñÍâ²¿P5.4×öÊäÈë.
  45          #define CMPOE   0x02    //1: ÔÊÐí±È½Ï½á¹ûÊä³öµ½P1.2, 0: ½ûÖ¹.
  46          #define CMPRES  0x01    //±È½Ï½á¹û, 1: CMP+µçÆ½¸ßÓÚCMP-,  0: CMP+µçÆ½µÍÓÚCMP-,  Ö»¶Á
  47          
  48          //CMPCR2
  49          #define INVCMPO 0x80    //1: ±È½ÏÆ÷Êä³öÈ¡·´,  0: ²»È¡·´
  50          #define DISFLT  0x40    //1: ¹Ø±Õ0.1uFÂË²¨,   0: ÔÊÐí
  51          #define LCDTY   0x00    //0~63, ±È½Ï½á¹û±ä»¯ÑÓÊ±ÖÜÆÚÊý
  52          
  53          sbit SWK = P3^3; //Íâ²¿°´¼ü
  54          sbit LED = P5^5; //LED
C51 COMPILER V9.54   MAIN                                                                  08/26/2021 23:45:46 PAGE 2   

  55          
  56          
  57          sbit PWM2_L = P3^4;
  58          sbit PWM1_L = P3^5;
  59          sbit PWM0_L = P3^6;
  60          
  61          
  62          u8      Step;
  63          u8      PWM_Value; // ¾ö¶¨PWMÕ¼¿Õ±ÈµÄÖµ
  64          u16     RxPulseWide; //
  65          bit     B_RxOk;
  66          bit     B_RUN;
  67          u8      PWW_Set;
  68          u8      Rx_cnt;
  69          u8      TimeOut;        //¶Â×ª³¬Ê±
  70          
  71          #define DISABLE_CMP_INT CMPCR1 &= ~0X40         // ¹Ø±Õ±È½ÏÆ÷ÖÐ¶Ï
  72          #define ENABLE_CMP_INT  CMPCR1 |= 0X40          // ´ò¿ª±È½ÏÆ÷ÖÐ¶Ï
  73          
  74          /*************************/
  75          
  76          void    Delay_n_ms(u8 dly)
  77          {
  78   1              u16     j;
  79   1              do
  80   1              {
  81   2                      j = MAIN_Fosc / 13000;  //ÑÓÊ±1ms, Ö÷³ÌÐòÔÚ´Ë½ÚÅÄÏÂÔËÐÐ
  82   2                      while(--j)      ;
  83   2              }while(--dly);
  84   1      }
  85          
  86          
  87          void delay_us(u8 us)
  88          {
  89   1              do
  90   1              {
  91   2                      NOP(20);        //@24MHz
  92   2              }
  93   1              while(--us);
  94   1      }
  95           void StepXL(void) // »»ÏàÐòÁÐº¯Êý
  96          {
  97   1       switch(Step)
  98   1        {
  99   2              case 0:  //AB
 100   2                      CCAP1H = PWM_Value;CCAP2H=0;CCAP0H=0;//´ò¿ªBÏà ¸º¼«
 101   2                      PWM0_L=1;PWM1_L =0;PWM2_L=0;//´ò¿ªAÏàµÄ¸ß
 102   2                      ADC_CONTR = 0XED;       CMPCR1 = 0xAC;// Ñ¡ÔñP1.5×÷ÎªADCÊäÈë ¼´cÏàµçÑ¹  ÉÏÉýÑØÖÐ¶Ï
 103   2                      break;
 104   2              case 1:  //AC
 105   2                      CCAP2H = PWM_Value;CCAP0H=0;CCAP1H=0;//´ò¿ªCÏà ¸º¼«
 106   2                      PWM0_L=1;PWM1_L =0;PWM2_L=0;//´ò¿ªAÏàµÄ¸ß
 107   2                      ADC_CONTR = 0XEC;       CMPCR1 = 0x9C;// Ñ¡ÔñP1.4×÷ÎªADCÊäÈë ¼´BÏàµçÑ¹  ÏÂ½µÑØÖÐ¶Ï
 108   2                      break;
 109   2              case 2:  //BC
 110   2                      CCAP2H = PWM_Value;CCAP0H=0;CCAP1H=0;//´ò¿ªCÏà ¸º¼«
 111   2                      PWM0_L=0;PWM1_L =1;PWM2_L=0;//´ò¿ªBÏàµÄ¸ß
 112   2                      ADC_CONTR = 0XEB;       CMPCR1 = 0xAC;// Ñ¡ÔñP1.3×÷ÎªADCÊäÈë ¼´aÏàµçÑ¹  ÉÏÉýÑØÖÐ¶Ï
 113   2                      break;
 114   2              case 3:  //BA
 115   2                      CCAP0H = PWM_Value;CCAP1H=0;CCAP2H=0;//´ò¿ªAÏà ¸º¼«
 116   2                      PWM0_L=0;PWM1_L =1;PWM2_L=0;//´ò¿ªBÏàµÄ¸ß
C51 COMPILER V9.54   MAIN                                                                  08/26/2021 23:45:46 PAGE 3   

 117   2                      ADC_CONTR = 0XED;       CMPCR1 = 0x9C;// Ñ¡ÔñP1.5×÷ÎªADCÊäÈë ¼´cÏàµçÑ¹  ÏÂ½µÑØÖÐ¶Ï
 118   2                      break;
 119   2              case 4:  //CA
 120   2                      CCAP0H = PWM_Value;CCAP1H=0;CCAP2H=0;//´ò¿ªAÏà ¸º¼«
 121   2                      PWM0_L=0;PWM1_L =0;PWM2_L=1;//´ò¿ªCÏàµÄ¸ß
 122   2                      ADC_CONTR = 0XEC;       CMPCR1 = 0xAC;// Ñ¡ÔñP1.4×÷ÎªADCÊäÈë ¼´BÏàµçÑ¹  ÉÏÉýÑØÖÐ¶Ï
 123   2                      break;
 124   2              case 5:  //CB
 125   2                      CCAP1H = PWM_Value;CCAP2H=0;CCAP0H=0;//´ò¿ªBÏà ¸º¼«
 126   2                      PWM0_L=0;PWM1_L =0;PWM2_L=1;//´ò¿ªCÏàµÄ¸ß
 127   2                      ADC_CONTR = 0XEB;       CMPCR1 = 0x9C;// Ñ¡ÔñP1.3×÷ÎªADCÊäÈë ¼´aÏàµçÑ¹  ÏÂ½µÑØÖÐ¶Ï
 128   2                      break;
 129   2      
 130   2      
 131   2              default:
 132   2                      break;
 133   2        }     
 134   1      }
 135          
 136          #define CCP_S0 0x10                 //P_SW1.4
 137          #define CCP_S1 0x20                 //P_SW1.5
 138          void PWM_Init(void)
 139          {
 140   1              PWM0_L = 0;
 141   1              PWM1_L = 0;
 142   1              PWM2_L = 0;
 143   1              
 144   1              P3M0=0x70;P3M1=0x00;
 145   1              P5M0=0x00;P5M1=0x00;
 146   1      
 147   1         
 148   1      //      CMOD = 1 << 1; //Ñ¡ÔñÏµÍ³Ê±ÖÓ/2ÎªÊ±ÖÓÔ´£¬¼´PWMÆµÂÊ=24M/2/256=46.9K
 149   1      //      CMOD = 5 << 1; //Ñ¡ÔñÏµÍ³Ê±ÖÓ/4ÎªÊ±ÖÓÔ´£¬¼´PWMÆµÂÊ=24M/4/256=23.4K
 150   1              CMOD = 6 << 1; //Ñ¡ÔñÏµÍ³Ê±ÖÓ/6ÎªÊ±ÖÓÔ´£¬¼´PWMÆµÂÊ=24M/6/256=15.6K(Ð§¹ûºÃ)
 151   1      
 152   1              CL=0;                   // PCA¼ÆÊýÆ÷ÇåÁã
 153   1              CH=0;
 154   1      
 155   1              
 156   1              PCA_PWM0 = 0X00;
 157   1              CCAP0H=0;    // ³õÊ¼»¯Õ¼¿Õ±ÈÎª0% HµÄÖµ×°ÔØµ½LÖÐ
 158   1              CCAP0L=0;
 159   1              CCAPM0=0x42;    // ÉèÖÃÎªPWMÄ£Ê½
 160   1              
 161   1              PCA_PWM1 = 0X00;
 162   1              CCAP1H=0;    // ³õÊ¼»¯Õ¼¿Õ±ÈÎª0%
 163   1              CCAP1L=0;
 164   1              CCAPM1=0x42;    // ÉèÖÃÎªPWMÄ£Ê½
 165   1              
 166   1              PCA_PWM2 = 0X00;
 167   1              CCAP2H=0;    // ³õÊ¼»¯Õ¼¿Õ±ÈÎª0%
 168   1              CCAP2L=0;
 169   1              CCAPM2=0x42;    // ÉèÖÃÎªPWMÄ£Ê½
 170   1              
 171   1              CR = 1;
 172   1      }
 173          
 174          void ADC_Init(void)
 175          {
 176   1              P1M0=0x00;P1M1=0x1C;
 177   1              P1ASF = 0X38; // ¿ªÍ¨P1.3 P1.4 P1.5µÄADÊäÈë¿Ú
 178   1      }
C51 COMPILER V9.54   MAIN                                                                  08/26/2021 23:45:46 PAGE 4   

 179          //ADCÖÐ¶Ï
 180          void CMP_INT(void) interrupt 21
 181          {
 182   1              CMPCR1 &= ~0X40; // ÐèÈí¼þÇå³ýÖÐ¶Ï±êÖ¾Î»
 183   1              if(Step<5)      Step++;  //»»Ïò
 184   1              else            Step = 0;
 185   1              StepXL();
 186   1              TimeOut = 15;   //10ms³¬Ê±
 187   1      }
 188          
 189          void CMP_Init(void)
 190          {
 191   1              CMPCR1 = 0X8C;  // 1000 1100 ´ò¿ª±È½ÏÆ÷£¬P5.4×÷Îª±È½ÏÆ÷µÄ·´ÏàÊäÈë¶Ë£¬ADCÒý½Å×÷ÎªÕýÊäÈë¶Ë 
 192   1              CMPCR2 = 60;    // 60¸öÊ±ÖÓÂË²¨
 193   1              P5n_pure_input(0x10);
 194   1      }
 195          
 196          u8 StartMotor(void)       //Æô¶¯µç»úº¯Êý
 197          {
 198   1              u16 timer,i;
 199   1              DISABLE_CMP_INT; // ¹Ø±È½ÏÆ÷ÖÐ¶Ï
 200   1              PWM_Value = 70; // ³õÊ¼Õ¼¿Õ±È
 201   1              Step = 1;StepXL();      // ³õÊ¼Î»ÖÃ
 202   1              Delay_n_ms(8);          //Æô¶¯³ÖÐøÊ±¼ä£¨²»ÄÜÌ«¸ß£©
 203   1              PWM_Value = 50; // ³õÊ¼Õ¼¿Õ±È
 204   1              Delay_n_ms(20); //Æô¶¯³ÖÐøÊ±¼ä£¨²»ÄÜÌ«¸ß£©
 205   1              PWM_Value = PWM_Value;// 
 206   1              timer = 50;   //
 207   1      //      return(1);
 208   1              while(1)
 209   1              {
 210   2                      for(i=0; i<timer; i++)  delay_us(50);
 211   2                      timer--;
 212   2                      if(timer < 35)
 213   2                        {
 214   3                         PWM0_L=0;PWM1_L =0;PWM2_L=0;//´ò¿ªAÏàµÄ¸ß
 215   3                         CCAP2H=0;CCAP0H=0;CCAP1H=0;//´ò¿ªCÏà ¸º¼«
 216   3                         return(1);//Ìø³öÑ­»·
 217   3                        }     
 218   2                      if( Step < 5)   Step++;
 219   2                      else                    Step = 0;
 220   2                      StepXL();
 221   2              }
 222   1      }
 223          
 224          
 225          
 226          /**********************************************/
 227          void main(void)
 228          {
 229   1              u16 kk;
 230   1          bit ready_bz=1;
 231   1              
 232   1              PWM_Init();
 233   1              ADC_Init();
 234   1              CMP_Init();
 235   1              LED = 0; //µãÁÁLED
 236   1      
 237   1       ////////////////////////////////
 238   1       //¿ª»úÏì3ÏÂ  ¡¾1£»2£»3¡¿
 239   1              Delay_n_ms(250);        
 240   1          PWM_Value = 30;     //ÒôÁ¿´óÐ¡      10-100
C51 COMPILER V9.54   MAIN                                                                  08/26/2021 23:45:46 PAGE 5   

 241   1              Step = 0;
 242   1              StepXL();                       // ³õÊ¼Î»ÖÃ
 243   1              Delay_n_ms(10);
 244   1      
 245   1              for(kk=1500; kk>0; kk--)
 246   1              {Step = 1,StepXL(),delay_us(10);                        // ³õÊ¼Î»ÖÃ;  //
 247   2               Step = 3,StepXL(),delay_us(10);}
 248   1              Delay_n_ms(250);        
 249   1              for(kk=1500; kk>0; kk--)
 250   1              {Step = 1,StepXL(),delay_us(15);                        // ³õÊ¼Î»ÖÃ;  //
 251   2               Step = 3,StepXL(),delay_us(15);}
 252   1              Delay_n_ms(250);        
 253   1              for(kk=1500; kk>0; kk--)
 254   1              {Step = 1,StepXL(),delay_us(20);                        // ³õÊ¼Î»ÖÃ;  //
 255   2               Step = 3,StepXL(),delay_us(20);}
 256   1      
 257   1       //////////////////////////////////////
 258   1      
 259   1      
 260   1              PWM_Value = 0;
 261   1              RxPulseWide = 1000;
 262   1              PWW_Set = 0;
 263   1              Rx_cnt  = 0;
 264   1              TimeOut = 0;
 265   1      
 266   1              EA  = 1; // ´ò¿ª×ÜÖÐ¶Ï
 267   1              LED = 1; //¹Ø±ÕLED
 268   1              
 269   1              while (1)
 270   1              {
 271   2              Delay_n_ms(1);  //ÑÓÊ±1ms, Ö÷³ÌÐòÔÚ´Ë½ÚÅÄÏÂÔËÐÐ
 272   2      
 273   2              //
 274   2              if(SWK==0)      //Âí´ïÎ´ÔËÐÐ, ÔòÆô¶¯Âí´ï
 275   2              {
 276   3               LED=0;//LED
 277   3               StartMotor();  // Æô¶¯Âí´ï
 278   3      //       CMPCR1 &= ~0X40;// ÐèÈí¼þÇå³ýÖÐ¶Ï±êÖ¾Î»
 279   3               ENABLE_CMP_INT; // ´ò¿ª±È½ÏÆ÷ÖÐ¶Ï
 280   3               TimeOut = 0;
 281   3               B_RUN = 1;
 282   3               while(SWK==0)  //Õý³£Ðý×ªÊ¹ÓÃÒ»ÏÂ³ÌÐò
 283   3                      {
 284   4                   LED=1;//LED
 285   4                       PWM_Value=150;
 286   4                      }
 287   3              }
 288   2              else
 289   2              {
 290   3               PWM_Value = 0;
 291   3               B_RUN = 0;
 292   3               CCAP0H=0;      CCAP1H=0;       CCAP2H=0;  // Õ¼¿Õ±ÈÎª0
 293   3               PWM0_L=0;      PWM1_L=0;       PWM2_L=0;  // ÏàÐò À­µ×¸´Î»
 294   3               DISABLE_CMP_INT; // ¹Ø±È½ÏÆ÷ÖÐ¶Ï
 295   3              }
 296   2                   
 297   2              
 298   2              }
 299   1      }
 300          
 301          
 302          
C51 COMPILER V9.54   MAIN                                                                  08/26/2021 23:45:46 PAGE 6   



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    596    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      7    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
